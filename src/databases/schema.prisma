// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../databases/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum DocumentType {
  dni // cedula
  passport
}

// TABLE islands
model islands {
  id          String  @id @default(uuid())
  name        String  @db.VarChar(100)
  code        String  @unique @db.VarChar(10)
  description String  @db.Text
  is_active   Boolean @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  // Relations one-to-many
  ports      ports[]
}

// TABLE ports
model ports {
  id      String   @id @default(uuid())
  // Relations many-to-one
  islands islands? @relation(fields: [island_id], references: [id])

  island_id     String?
  //
  name          String   @db.VarChar(100)
  code          String   @unique @db.VarChar(10)
  address       String?  @db.VarChar(255)
  contact_phone String?  @db.VarChar(20)
  latitude      Decimal? @db.Decimal(10, 8)
  longitude     Decimal? @db.Decimal(11, 8)
  is_active     Boolean  @default(true)

  opening_time       DateTime @default(now())
  closing_time       DateTime @default(now())
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  // Relations one-to-many
  origin_routes      routes[] @relation("origin_routes")
  destination_routes routes[] @relation("destination_routes")
}

// TABLE routes
model routes {
  id                String @id @default(uuid())
  // Relations many-to-one
  origin_ports      ports  @relation("origin_routes", fields: [origin_port_id], references: [id])
  destination_ports ports  @relation("destination_routes", fields: [destination_port_id], references: [id])

  origin_port_id      String
  destination_port_id String
  //
  distance_km         Decimal? @db.Decimal(6, 2)
  duration_minutes    Int
  base_price_resident Decimal  @db.Decimal(10, 2)
  base_price_national Decimal  @db.Decimal(10, 2)
  base_price_foreign  Decimal  @db.Decimal(10, 2)
  is_active           Boolean  @default(true)

  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  // Relations one-to-many
  schedules  schedules[]
}

// TABLE ferries
enum FerryStatus {
  active
  maintenance
  retired
}

model ferries {
  id             String  @id @default(uuid())
  name           String  @db.VarChar(100)
  register_code  String  @unique @db.VarChar(30)
  capacity       Int
  operator_name  String  @db.VarChar(100)
  operator_phone String? @db.VarChar(20)
  operator_email String? @db.VarChar(255)
  year_built     Int?
  amenities      Json    @default("{}") @db.JsonB

  status FerryStatus @default(active)

  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  // Relations one-to-many
  schedules  schedules[]
}

// TABLE schedules
enum ScheduleStatus {
  scheduled
  boarding
  in_transit
  completed
  cancelled
}

model schedules {
  id      String   @id @default(uuid())
  // Relations many-to-one
  routes  routes?  @relation(fields: [route_id], references: [id])
  ferries ferries? @relation(fields: [ferry_id], references: [id])

  route_id            String?
  ferry_id            String?
  //
  total_capacity      Int
  available_seats     Int
  cancellation_reason String? @db.Text
  notes               String? @db.Text

  status ScheduleStatus @default(scheduled)

  departure_date   DateTime
  departure_time   DateTime
  arrival_time     DateTime
  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt
  // Relations one-to-many
  seat_holds       seat_holds[]
  return_tickets   tickets[]    @relation("return_tickets")
  outbound_tickets tickets[]    @relation("outbound_tickets")
}

// TABLE users
model users {
  id              String  @id @default(uuid())
  firstName       String  @db.VarChar(100)
  lastName        String  @db.VarChar(100)
  email           String  @unique @db.VarChar(255)
  phone           String? @db.VarChar(20)
  document_number String  @db.VarChar(50)

  document_type DocumentType

  created_at DateTime     @default(now())
  updated_at DateTime     @updatedAt
  // Relations one-to-many
  tickets    tickets[]
  seat_holds seat_holds[]
}

// TABLE passengers
model passengers {
  id      String   @id @default(uuid())
  // Relations many-to-one
  tickets tickets? @relation(fields: [ticket_id], references: [id])

  ticket_id           String?
  //
  first_name          String  @db.VarChar(100)
  last_name           String  @db.VarChar(100)
  email               String? @db.VarChar(255)
  phone               String? @db.VarChar(20)
  document_number     String  @db.VarChar(50)
  unit_price          Decimal @db.Decimal(10, 2)
  is_primary          Boolean @default(false)
  checked_in_outbound Boolean @default(false)
  checked_in_return   Boolean @default(false)

  document_type DocumentType

  checked_in_outbound_at DateTime?
  checked_in_return_at   DateTime?
  created_at             DateTime  @default(now())
}

// TABLE payments
enum PaymentMethod {
  credit_card
  debit_card
  paypal
  bank_transfer
  cash
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
  partial_refund
}

model payments {
  id      String   @id @default(uuid())
  // Relations many-to-one
  tickets tickets? @relation(fields: [ticket_id], references: [id])

  ticket_id               String?
  //
  payment_provider        String   @db.VarChar(50)
  provider_transaction_id String?  @db.VarChar(255)
  provider_payment_intent String?  @db.VarChar(255)
  amount                  Decimal  @db.Decimal(10, 2)
  currency                String   @default("USD") @db.VarChar(3)
  error_code              String?  @db.VarChar(50)
  error_message           String?  @db.Text
  attempts                Int      @default(1)
  refund_amount           Decimal? @db.Decimal(10, 2)
  refund_text             String?  @db.Text
  metadata                Json?    @default("{}") @db.JsonB
  ip_address              String?  @db.VarChar(45)
  user_agent              String?  @db.Text

  payment_method PaymentMethod
  status         PaymentStatus @default(pending)

  paid_at     DateTime? @default(now())
  refunded_at DateTime? @default(now())
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
}

// TABLE seat_holds
enum SeatHoldsStatus {
  held
  confirmed
  expired
  released
}

model seat_holds {
  id        String     @id @default(uuid())
  // Relations many-to-one
  users     users?     @relation(fields: [user_id], references: [id])
  schedules schedules? @relation(fields: [schedule_id], references: [id])

  user_id     String?
  schedule_id String?
  //
  quantity    Int

  status SeatHoldsStatus @default(held)

  held_at         DateTime  @default(now())
  expires_at      DateTime  @default(now()) // held_at + 15min
  confirmed_at    DateTime?
  released_at     DateTime?
  created_at      DateTime  @default(now())
  // Relations one-to-one
  outbound_ticket tickets?  @relation("outbound_hold")
  return_ticket   tickets?  @relation("return_hold")
}

// TABLE tickets
enum TicketsTripType {
  one_way
  round_trip
}

enum TicketsStatus {
  pending
  confirmed
  checked_in
  completed
  cancelled
  refunded
  expired
}

model tickets {
  id                 String     @id @default(uuid())
  // Relations many-to-one
  users              users?     @relation(fields: [user_id], references: [id])
  return_schedules   schedules? @relation("return_tickets", fields: [return_schedule_id], references: [id])
  outbound_schedules schedules? @relation("outbound_tickets", fields: [outbound_schedule_id], references: [id])

  return_schedule_id   String?
  user_id              String?
  outbound_schedule_id String?
  // Relations one-to-one
  outbound_hold        seat_holds? @relation("outbound_hold", fields: [outbound_hold_id], references: [id])
  return_hold          seat_holds? @relation("return_hold", fields: [return_hold_id], references: [id])

  return_hold_id      String? @unique
  outbound_hold_id    String? @unique
  //
  ticket_code         String  @unique @db.VarChar(20)
  total_passengers    Int
  subtotal            Decimal @db.Decimal(10, 2)
  taxes               Decimal @default(0) @db.Decimal(10, 2)
  service_fee         Decimal @default(0) @db.Decimal(10, 2)
  discount            Decimal @default(0) @db.Decimal(10, 2)
  total               Decimal @db.Decimal(10, 2)
  currency            String  @default("USD") @db.VarChar(3)
  qr_code             String? @db.Text
  cancellation_reason String? @db.Text

  trip_type TicketsTripType
  status    TicketsStatus   @default(pending)

  booking_expires_at DateTime?
  confirmed_at       DateTime?    @default(now())
  cancelled_at       DateTime?    @default(now())
  created_at         DateTime     @default(now())
  updated_at         DateTime     @updatedAt
  // Relations one-to-many
  passengers         passengers[]
  payments           payments[]
}
